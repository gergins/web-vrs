const fs = require("fs");
const path = require("path");

const ROOT = process.cwd();
const OUT_PATH = path.join(ROOT, "docs", "architecture", "repo-structure.md");
const MAX_DEPTH = 6;
const IGNORE = new Set([".git", "node_modules"]);

function listTree(dir, depth = 0) {
  if (depth > MAX_DEPTH) return [];
  const entries = fs
    .readdirSync(dir, { withFileTypes: true })
    .filter((e) => !IGNORE.has(e.name))
    .sort((a, b) => a.name.localeCompare(b.name));

  const lines = [];
  for (const entry of entries) {
    const rel = path.relative(ROOT, path.join(dir, entry.name)).replace(/\\/g, "/");
    const indent = "  ".repeat(depth);
    if (entry.isDirectory()) {
      lines.push(`${indent}- ${rel}/`);
      lines.push(...listTree(path.join(dir, entry.name), depth + 1));
    } else {
      lines.push(`${indent}- ${rel}`);
    }
  }
  return lines;
}

function render() {
  const timestamp = new Date().toISOString();
  const lines = [
    "# Repository Structure",
    "",
    `Generated: ${timestamp}`,
    "",
    "## Tree",
    ...listTree(ROOT),
    "",
    "## Notes",
    "- Auto-generated by `npm run structure:update`.",
    "- Refresh after adding, moving, or deleting files/folders.",
    ""
  ];
  return lines.join("\n");
}

fs.mkdirSync(path.dirname(OUT_PATH), { recursive: true });
fs.writeFileSync(OUT_PATH, render(), "utf8");
console.log(`Structure map updated: ${OUT_PATH}`);
